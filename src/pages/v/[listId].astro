---
import RootLayout from "@/layouts/root-layout.astro";
import { getExpandedList } from "@/actions/helpers";

import RadixProvider from "@/app/components/ui/radix-provider";
import { Badge, Button, Link } from "@radix-ui/themes";
import ViewerList from "@/app/modules/list-viewer/list-viewer";
import { createDb } from "@/db";
import { ListUser, User } from "@/db/schema";
import { eq } from "drizzle-orm";

const { listId = "" } = Astro.params;
const list = await getExpandedList(Astro, listId);

if (!list) {
  return new Response("List not found", { status: 404 });
}

if (!list.isPublic) {
  return new Response("List is not public", { status: 403 });
}

const db = createDb(Astro.locals.runtime.env)
const [listOwner] = await db
  .select({id: User.id, name: User.name})
  .from(User)
  .innerJoin(ListUser, eq(ListUser.userId, User.id))
  .where(eq(ListUser.listId, listId));
const isListOwner = Astro.locals.user?.id === listOwner.id;

if (!listOwner) {
  return new Response("List owner not found", { status: 404 });
}
---

<RootLayout>
  <RadixProvider>
    <main class="overflow-auto h-full">
      <div class="container2 py-8 pb-20 grid gap-4">
        <header
          class="flex flex-col sm:flex-row justify-between gap-2 sm:items-center"
        >
          <Badge className="w-fit">
            Created by {listOwner.name} using <Link href="/">LightTravel</Link>
          </Badge>
          {
            isListOwner && (
              <a href={`/list/${listId}`}>
                <Button variant="soft">
                  <i class="fa-solid fa-pen-to-square" />
                  <span>Edit List</span>
                </Button>
              </a>
            )
          }
        </header>
        <ViewerList client:load list={list} />
      </div>
    </main>
  </RadixProvider>
</RootLayout>
